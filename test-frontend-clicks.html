<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端点击测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #iframe-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 前端导航栏二级菜单点击测试</h1>
        
        <div class="test-result info">
            <strong>测试说明：</strong>这个测试将在iframe中加载管理后台，然后自动测试二级菜单的点击功能。
        </div>
        
        <button onclick="startTest()">开始测试</button>
        <button onclick="clearLog()">清空日志</button>
        
        <div id="log" class="log"></div>
        
        <div id="iframe-container" style="display: none;">
            <iframe id="admin-frame" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let testLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logDiv = document.getElementById('log');
            const logLine = document.createElement('div');
            logLine.textContent = logEntry;
            logLine.className = type;
            logDiv.appendChild(logLine);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(logEntry);
        }
        
        function clearLog() {
            testLog = [];
            document.getElementById('log').innerHTML = '';
        }
        
        async function startTest() {
            log('🚀 开始前端点击测试', 'info');
            
            try {
                // 1. 加载管理后台页面
                log('1. 加载管理后台页面...', 'info');
                const iframe = document.getElementById('admin-frame');
                const container = document.getElementById('iframe-container');
                container.style.display = 'block';
                
                // 先尝试访问登录页面
                iframe.src = 'http://localhost:3002/admin/login';
                
                await waitForIframeLoad(iframe);
                log('✅ 登录页面加载完成', 'success');
                
                // 2. 等待一段时间让页面完全渲染
                await sleep(2000);
                
                // 3. 尝试自动登录（通过postMessage或直接操作iframe内容）
                log('2. 尝试自动登录...', 'info');
                
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // 检查是否有登录表单
                    const usernameInput = iframeDoc.querySelector('input[name="username"], input[type="text"]');
                    const passwordInput = iframeDoc.querySelector('input[name="password"], input[type="password"]');
                    const loginButton = iframeDoc.querySelector('button[type="submit"], button:contains("登录")');
                    
                    if (usernameInput && passwordInput) {
                        usernameInput.value = 'admin';
                        passwordInput.value = 'Admin123!';
                        
                        // 触发输入事件
                        usernameInput.dispatchEvent(new Event('input', { bubbles: true }));
                        passwordInput.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        log('✅ 填写登录信息完成', 'success');
                        
                        if (loginButton) {
                            loginButton.click();
                            log('✅ 点击登录按钮', 'success');
                            
                            // 等待登录完成
                            await sleep(3000);
                            
                            // 检查是否跳转到管理后台
                            const currentUrl = iframe.contentWindow.location.href;
                            log(`当前URL: ${currentUrl}`, 'info');
                            
                            if (currentUrl.includes('/admin') && !currentUrl.includes('/login')) {
                                log('✅ 登录成功，已跳转到管理后台', 'success');
                                
                                // 4. 测试二级菜单点击
                                await testMenuClicks(iframe);
                                
                            } else {
                                log('❌ 登录可能失败，仍在登录页面', 'error');
                            }
                        } else {
                            log('❌ 未找到登录按钮', 'error');
                        }
                    } else {
                        log('❌ 未找到登录表单', 'error');
                        
                        // 尝试直接访问管理后台（可能已经登录）
                        log('3. 尝试直接访问管理后台...', 'info');
                        iframe.src = 'http://localhost:3002/admin/dashboard';
                        await waitForIframeLoad(iframe);
                        await sleep(2000);
                        
                        await testMenuClicks(iframe);
                    }
                    
                } catch (error) {
                    log(`❌ 跨域访问限制: ${error.message}`, 'error');
                    log('ℹ️  由于跨域限制，无法直接操作iframe内容', 'warning');
                    log('ℹ️  请手动在iframe中登录，然后点击"测试菜单点击"按钮', 'warning');
                }
                
            } catch (error) {
                log(`❌ 测试过程中出现错误: ${error.message}`, 'error');
            }
        }
        
        async function testMenuClicks(iframe) {
            log('4. 开始测试二级菜单点击...', 'info');
            
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // 查找新闻管理菜单项
                const newsMenuButton = iframeDoc.querySelector('button:contains("新闻管理")') ||
                                     Array.from(iframeDoc.querySelectorAll('button')).find(btn => 
                                         btn.textContent.includes('新闻管理'));
                
                if (newsMenuButton) {
                    log('✅ 找到新闻管理菜单按钮', 'success');
                    
                    // 点击新闻管理菜单
                    newsMenuButton.click();
                    log('✅ 点击新闻管理菜单', 'success');
                    
                    await sleep(1000);
                    
                    // 检查二级菜单是否展开
                    const subMenuItems = iframeDoc.querySelectorAll('a[href*="/admin/news/"]');
                    
                    if (subMenuItems.length > 0) {
                        log(`✅ 发现 ${subMenuItems.length} 个二级菜单项`, 'success');
                        
                        // 测试点击每个二级菜单项
                        for (let i = 0; i < subMenuItems.length; i++) {
                            const item = subMenuItems[i];
                            const href = item.getAttribute('href');
                            const text = item.textContent.trim();
                            
                            log(`测试点击: ${text} (${href})`, 'info');
                            
                            try {
                                item.click();
                                await sleep(1000);
                                
                                const currentUrl = iframe.contentWindow.location.href;
                                if (currentUrl.includes(href)) {
                                    log(`✅ ${text} 点击成功，已跳转到 ${href}`, 'success');
                                } else {
                                    log(`❌ ${text} 点击后未跳转到预期页面`, 'error');
                                }
                            } catch (error) {
                                log(`❌ 点击 ${text} 时出错: ${error.message}`, 'error');
                            }
                        }
                        
                    } else {
                        log('❌ 点击新闻管理后未发现二级菜单项', 'error');
                    }
                    
                } else {
                    log('❌ 未找到新闻管理菜单按钮', 'error');
                    
                    // 列出所有可能的按钮
                    const allButtons = iframeDoc.querySelectorAll('button');
                    log(`页面中共有 ${allButtons.length} 个按钮:`, 'info');
                    allButtons.forEach((btn, index) => {
                        log(`  ${index + 1}. ${btn.textContent.trim()}`, 'info');
                    });
                }
                
            } catch (error) {
                log(`❌ 测试菜单点击时出错: ${error.message}`, 'error');
            }
        }
        
        function waitForIframeLoad(iframe) {
            return new Promise((resolve) => {
                iframe.onload = resolve;
            });
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
