<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯ç‚¹å‡»æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #iframe-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª å‰ç«¯å¯¼èˆªæ äºŒçº§èœå•ç‚¹å‡»æµ‹è¯•</h1>
        
        <div class="test-result info">
            <strong>æµ‹è¯•è¯´æ˜ï¼š</strong>è¿™ä¸ªæµ‹è¯•å°†åœ¨iframeä¸­åŠ è½½ç®¡ç†åå°ï¼Œç„¶åè‡ªåŠ¨æµ‹è¯•äºŒçº§èœå•çš„ç‚¹å‡»åŠŸèƒ½ã€‚
        </div>
        
        <button onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        
        <div id="log" class="log"></div>
        
        <div id="iframe-container" style="display: none;">
            <iframe id="admin-frame" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let testLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logDiv = document.getElementById('log');
            const logLine = document.createElement('div');
            logLine.textContent = logEntry;
            logLine.className = type;
            logDiv.appendChild(logLine);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(logEntry);
        }
        
        function clearLog() {
            testLog = [];
            document.getElementById('log').innerHTML = '';
        }
        
        async function startTest() {
            log('ğŸš€ å¼€å§‹å‰ç«¯ç‚¹å‡»æµ‹è¯•', 'info');
            
            try {
                // 1. åŠ è½½ç®¡ç†åå°é¡µé¢
                log('1. åŠ è½½ç®¡ç†åå°é¡µé¢...', 'info');
                const iframe = document.getElementById('admin-frame');
                const container = document.getElementById('iframe-container');
                container.style.display = 'block';
                
                // å…ˆå°è¯•è®¿é—®ç™»å½•é¡µé¢
                iframe.src = 'http://localhost:3002/admin/login';
                
                await waitForIframeLoad(iframe);
                log('âœ… ç™»å½•é¡µé¢åŠ è½½å®Œæˆ', 'success');
                
                // 2. ç­‰å¾…ä¸€æ®µæ—¶é—´è®©é¡µé¢å®Œå…¨æ¸²æŸ“
                await sleep(2000);
                
                // 3. å°è¯•è‡ªåŠ¨ç™»å½•ï¼ˆé€šè¿‡postMessageæˆ–ç›´æ¥æ“ä½œiframeå†…å®¹ï¼‰
                log('2. å°è¯•è‡ªåŠ¨ç™»å½•...', 'info');
                
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç™»å½•è¡¨å•
                    const usernameInput = iframeDoc.querySelector('input[name="username"], input[type="text"]');
                    const passwordInput = iframeDoc.querySelector('input[name="password"], input[type="password"]');
                    const loginButton = iframeDoc.querySelector('button[type="submit"], button:contains("ç™»å½•")');
                    
                    if (usernameInput && passwordInput) {
                        usernameInput.value = 'admin';
                        passwordInput.value = 'Admin123!';
                        
                        // è§¦å‘è¾“å…¥äº‹ä»¶
                        usernameInput.dispatchEvent(new Event('input', { bubbles: true }));
                        passwordInput.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        log('âœ… å¡«å†™ç™»å½•ä¿¡æ¯å®Œæˆ', 'success');
                        
                        if (loginButton) {
                            loginButton.click();
                            log('âœ… ç‚¹å‡»ç™»å½•æŒ‰é’®', 'success');
                            
                            // ç­‰å¾…ç™»å½•å®Œæˆ
                            await sleep(3000);
                            
                            // æ£€æŸ¥æ˜¯å¦è·³è½¬åˆ°ç®¡ç†åå°
                            const currentUrl = iframe.contentWindow.location.href;
                            log(`å½“å‰URL: ${currentUrl}`, 'info');
                            
                            if (currentUrl.includes('/admin') && !currentUrl.includes('/login')) {
                                log('âœ… ç™»å½•æˆåŠŸï¼Œå·²è·³è½¬åˆ°ç®¡ç†åå°', 'success');
                                
                                // 4. æµ‹è¯•äºŒçº§èœå•ç‚¹å‡»
                                await testMenuClicks(iframe);
                                
                            } else {
                                log('âŒ ç™»å½•å¯èƒ½å¤±è´¥ï¼Œä»åœ¨ç™»å½•é¡µé¢', 'error');
                            }
                        } else {
                            log('âŒ æœªæ‰¾åˆ°ç™»å½•æŒ‰é’®', 'error');
                        }
                    } else {
                        log('âŒ æœªæ‰¾åˆ°ç™»å½•è¡¨å•', 'error');
                        
                        // å°è¯•ç›´æ¥è®¿é—®ç®¡ç†åå°ï¼ˆå¯èƒ½å·²ç»ç™»å½•ï¼‰
                        log('3. å°è¯•ç›´æ¥è®¿é—®ç®¡ç†åå°...', 'info');
                        iframe.src = 'http://localhost:3002/admin/dashboard';
                        await waitForIframeLoad(iframe);
                        await sleep(2000);
                        
                        await testMenuClicks(iframe);
                    }
                    
                } catch (error) {
                    log(`âŒ è·¨åŸŸè®¿é—®é™åˆ¶: ${error.message}`, 'error');
                    log('â„¹ï¸  ç”±äºè·¨åŸŸé™åˆ¶ï¼Œæ— æ³•ç›´æ¥æ“ä½œiframeå†…å®¹', 'warning');
                    log('â„¹ï¸  è¯·æ‰‹åŠ¨åœ¨iframeä¸­ç™»å½•ï¼Œç„¶åç‚¹å‡»"æµ‹è¯•èœå•ç‚¹å‡»"æŒ‰é’®', 'warning');
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        async function testMenuClicks(iframe) {
            log('4. å¼€å§‹æµ‹è¯•äºŒçº§èœå•ç‚¹å‡»...', 'info');
            
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // æŸ¥æ‰¾æ–°é—»ç®¡ç†èœå•é¡¹
                const newsMenuButton = iframeDoc.querySelector('button:contains("æ–°é—»ç®¡ç†")') ||
                                     Array.from(iframeDoc.querySelectorAll('button')).find(btn => 
                                         btn.textContent.includes('æ–°é—»ç®¡ç†'));
                
                if (newsMenuButton) {
                    log('âœ… æ‰¾åˆ°æ–°é—»ç®¡ç†èœå•æŒ‰é’®', 'success');
                    
                    // ç‚¹å‡»æ–°é—»ç®¡ç†èœå•
                    newsMenuButton.click();
                    log('âœ… ç‚¹å‡»æ–°é—»ç®¡ç†èœå•', 'success');
                    
                    await sleep(1000);
                    
                    // æ£€æŸ¥äºŒçº§èœå•æ˜¯å¦å±•å¼€
                    const subMenuItems = iframeDoc.querySelectorAll('a[href*="/admin/news/"]');
                    
                    if (subMenuItems.length > 0) {
                        log(`âœ… å‘ç° ${subMenuItems.length} ä¸ªäºŒçº§èœå•é¡¹`, 'success');
                        
                        // æµ‹è¯•ç‚¹å‡»æ¯ä¸ªäºŒçº§èœå•é¡¹
                        for (let i = 0; i < subMenuItems.length; i++) {
                            const item = subMenuItems[i];
                            const href = item.getAttribute('href');
                            const text = item.textContent.trim();
                            
                            log(`æµ‹è¯•ç‚¹å‡»: ${text} (${href})`, 'info');
                            
                            try {
                                item.click();
                                await sleep(1000);
                                
                                const currentUrl = iframe.contentWindow.location.href;
                                if (currentUrl.includes(href)) {
                                    log(`âœ… ${text} ç‚¹å‡»æˆåŠŸï¼Œå·²è·³è½¬åˆ° ${href}`, 'success');
                                } else {
                                    log(`âŒ ${text} ç‚¹å‡»åæœªè·³è½¬åˆ°é¢„æœŸé¡µé¢`, 'error');
                                }
                            } catch (error) {
                                log(`âŒ ç‚¹å‡» ${text} æ—¶å‡ºé”™: ${error.message}`, 'error');
                            }
                        }
                        
                    } else {
                        log('âŒ ç‚¹å‡»æ–°é—»ç®¡ç†åæœªå‘ç°äºŒçº§èœå•é¡¹', 'error');
                    }
                    
                } else {
                    log('âŒ æœªæ‰¾åˆ°æ–°é—»ç®¡ç†èœå•æŒ‰é’®', 'error');
                    
                    // åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„æŒ‰é’®
                    const allButtons = iframeDoc.querySelectorAll('button');
                    log(`é¡µé¢ä¸­å…±æœ‰ ${allButtons.length} ä¸ªæŒ‰é’®:`, 'info');
                    allButtons.forEach((btn, index) => {
                        log(`  ${index + 1}. ${btn.textContent.trim()}`, 'info');
                    });
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•èœå•ç‚¹å‡»æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }
        
        function waitForIframeLoad(iframe) {
            return new Promise((resolve) => {
                iframe.onload = resolve;
            });
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
